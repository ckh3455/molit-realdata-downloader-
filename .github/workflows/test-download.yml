name: Test Download (Self-hosted)

on:
  # ìˆ˜ë™ ì‹¤í–‰ì„ ìœ„í•œ ì„¤ì •
  workflow_dispatch:
    inputs:
      test_months:
        description: 'í…ŒìŠ¤íŠ¸í•  ê°œì›” ìˆ˜ (Max months)'
        required: true
        default: '2'
        type: string

permissions:
  contents: read

jobs:
  test-download:
    # ğŸš¨ ë³€ê²½: ì„¤ì¹˜í•˜ì‹  Self-hosted Runnerë¥¼ ì‚¬ìš©í•˜ë„ë¡ ì§€ì •í•©ë‹ˆë‹¤.
    # ë§Œì•½ Runner ë“±ë¡ ì‹œ 'D-OneDrive-Runner'ì™€ ê°™ì€ ì´ë¦„ì„ ì§€ì •í–ˆë‹¤ë©´,
    # 'runs-on: D-OneDrive-Runner'ë¡œ ë³€ê²½í•˜ì…”ë„ ë©ë‹ˆë‹¤.
    runs-on: self-hosted 
    timeout-minutes: 30
    
    env:
      CI: "1"
      PYTHONUNBUFFERED: "1"
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      # ğŸš¨ ë³€ê²½: Windows í™˜ê²½ì´ë¯€ë¡œ Linuxìš© Chromium ì„¤ì¹˜ëŠ” í•„ìš” ì—†ìŠµë‹ˆë‹¤.
      # ë¡œì»¬ PCì— ì„¤ì¹˜ëœ Chrome ë˜ëŠ” Edgeë¥¼ ì‚¬ìš©í•˜ê²Œ ë©ë‹ˆë‹¤.
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          
      - name: Test download (limited months)
        # ì´ ëª…ë ¹ì´ D:\actions-runner í´ë”ì—ì„œ ì‹¤í–‰ë˜ë©°,
        # download_realdata.pyê°€ D:\OneDrive ê²½ë¡œì— ì ‘ê·¼í•˜ì—¬ íŒŒì¼ì„ ì €ì¥í•©ë‹ˆë‹¤.
        run: |
          python download_realdata.py --test-mode --max-months ${{ github.event.inputs.test_months }} 2>&1 | Out-File download_test.log -Encoding utf8
        shell: powershell # Windows í™˜ê²½ì´ë¯€ë¡œ PowerShell ì‰˜ì„ ëª…ì‹œí•©ë‹ˆë‹¤.
        continue-on-error: true
        
      - name: Show results
        if: always()
        # Windows í™˜ê²½ì— ë§ëŠ” ê²½ë¡œ íƒìƒ‰ ë° íŒŒì¼ ì¶œë ¥ ëª…ë ¹ì–´ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.
        run: |
          echo "========== Download Log =========="
          Get-Content download_test.log -ErrorAction SilentlyContinue
          echo ""
          echo "========== Downloaded Files =========="
          Get-ChildItem -Path output -Recurse -Filter "*.xlsx" | Select-Object FullName | Format-List
          echo ""
          echo "========== Progress =========="
          Get-Content download_progress.json -ErrorAction SilentlyContinue
        shell: powershell
        
      # ë‹¤ìš´ë¡œë“œëœ íŒŒì¼ì€ ì´ë¯¸ ë¡œì»¬ OneDriveì— ì €ì¥ë˜ì—ˆìœ¼ë¯€ë¡œ,
      # Artifactë¡œ ì—…ë¡œë“œí•˜ëŠ” ì´ ë‹¨ê³„ëŠ” ì„ íƒ ì‚¬í•­ì´ì§€ë§Œ, GitHubì—ì„œ ê²°ê³¼ í™•ì¸ì„ ìœ„í•´ ìœ ì§€í•©ë‹ˆë‹¤.
      - name: Upload downloaded files
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-downloads
          path: |
            output/**/*.xlsx
            download_test.log
            download_progress.json
          if-no-files-found: ignore
          retention-days: 3
