name: Download Real Estate Data

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 2ì‹œ (KST ê¸°ì¤€) ì‹¤í–‰
    - cron: '0 17 * * *'  # UTC 17:00 = KST 02:00
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  download:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          wget \
          unzip \
          gnupg \
          software-properties-common \
          apt-transport-https \
          ca-certificates
    
    - name: Install Chrome
      run: |
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
    
    - name: Install ChromeDriver
      run: |
        CHROME_VERSION=$(google-chrome --version | grep -oP '\d+\.\d+\.\d+\.\d+' | head -1)
        echo "Chrome version: $CHROME_VERSION"
        CHROME_MAJOR_VERSION=$(echo $CHROME_VERSION | cut -d. -f1)
        echo "Chrome major version: $CHROME_MAJOR_VERSION"
        
        # Chrome for Testing API ì‚¬ìš©
        CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/Latest-versions-per-milestone.json" | grep -oP "\"$CHROME_MAJOR_VERSION\.\d+\.\d+\.\d+\"" | head -1 | tr -d '"')
        if [ -z "$CHROMEDRIVER_VERSION" ]; then
          # í´ë°±: ChromeDriver 115+ ë²„ì „ìš©
          CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json" | grep -oP '"version":\s*"\K[\d.]+' | head -1)
        fi
        
        echo "ChromeDriver version: $CHROMEDRIVER_VERSION"
        wget -q "https://storage.googleapis.com/chrome-for-testing-public/${CHROMEDRIVER_VERSION}/linux64/chromedriver-linux64.zip" -O /tmp/chromedriver.zip || \
        wget -q "https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/${CHROMEDRIVER_VERSION}/linux64/chromedriver-linux64.zip" -O /tmp/chromedriver.zip
        
        unzip -q /tmp/chromedriver.zip -d /tmp
        sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/chromedriver
        sudo chmod +x /usr/local/bin/chromedriver
        rm -rf /tmp/chromedriver.zip /tmp/chromedriver-linux64
        
        chromedriver --version
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create service account JSON file
      env:
        GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
      run: |
        python -c "
        import json
        import os
        import sys
        
        # Secretì—ì„œ JSON ê°€ì ¸ì˜¤ê¸°
        json_str = os.environ.get('GCP_SERVICE_ACCOUNT_KEY', '')
        if not json_str:
            print('âŒ GCP_SERVICE_ACCOUNT_KEYê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤', file=sys.stderr)
            sys.exit(1)
        
        # JSON íŒŒì‹±í•˜ì—¬ ê²€ì¦
        try:
            json_data = json.loads(json_str)
            # íŒŒì¼ë¡œ ì €ì¥
            with open('service-account.json', 'w', encoding='utf-8') as f:
                json.dump(json_data, f, indent=2, ensure_ascii=False)
            print('âœ… service-account.json íŒŒì¼ ìƒì„± ì™„ë£Œ')
            print(f'   Keys: {list(json_data.keys())[:5]}...')
        except json.JSONDecodeError as e:
            print(f'âŒ JSON íŒŒì‹± ì˜¤ë¥˜: {e}', file=sys.stderr)
            print(f'   ì²« 100ì: {json_str[:100]}', file=sys.stderr)
            sys.exit(1)
        "
        chmod 600 service-account.json
    
    - name: Check existing files in Google Drive
      env:
        SERVICE_ACCOUNT_JSON: service-account.json
        GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
      run: |
        echo "=========================================="
        echo "ğŸ” Google Drive ê¸°ì¡´ íŒŒì¼ í™•ì¸ ì‹œì‘"
        echo "=========================================="
        python upload_to_gdrive.py --check-existing
        echo ""
        echo "=========================================="
        echo "âœ… ê¸°ì¡´ íŒŒì¼ í™•ì¸ ì™„ë£Œ"
        echo "=========================================="
        echo ""
        echo "=== existing_files.json ë‚´ìš© ==="
        cat existing_files.json 2>/dev/null || echo "íŒŒì¼ ì—†ìŒ"
        echo ""
    
    - name: Run download script
      env:
        CI: "1"
        CHROMEDRIVER_BIN: "/usr/local/bin/chromedriver"
        CHROME_BIN: "/usr/bin/google-chrome"
        SERVICE_ACCOUNT_JSON: service-account.json
        GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
      run: |
        python download_realdata.py --update-mode || echo "âš ï¸ ë‹¤ìš´ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤íŒ¨"
    
    - name: Upload new files to Google Drive
      if: always()
      env:
        SERVICE_ACCOUNT_JSON: service-account.json
        GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        OUTPUT_DIR: "output"
      run: |
        python upload_to_gdrive.py --upload || echo "âš ï¸ Google Drive ì—…ë¡œë“œ ì‹¤íŒ¨"
    
    - name: List files for debugging
      if: always()
      run: |
        echo "=== í˜„ì¬ ë””ë ‰í† ë¦¬ íŒŒì¼ ==="
        ls -la || echo "ls ì‹¤íŒ¨"
        echo ""
        echo "=== download_progress.json ==="
        cat download_progress.json 2>/dev/null || echo "íŒŒì¼ ì—†ìŒ"
        echo ""
        echo "=== existing_files.json ==="
        cat existing_files.json 2>/dev/null || echo "íŒŒì¼ ì—†ìŒ"
        echo ""
        echo "=== output í´ë” ==="
        ls -la output/ 2>/dev/null || echo "output í´ë” ì—†ìŒ"
    
    - name: Upload progress file as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: download-progress
        path: |
          download_progress.json
          existing_files.json
          output/
        if-no-files-found: warn
        retention-days: 7
