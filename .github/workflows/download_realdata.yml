name: Download Real Estate Data

on:
  schedule:
    # 매일 오전 2시 (KST 기준) 실행
    - cron: '0 17 * * *'  # UTC 17:00 = KST 02:00
  workflow_dispatch:  # 수동 실행 가능
    inputs:
      mode:
        description: 'Download mode'
        required: false
        default: 'update'
        type: choice
        options:
          - update
          - full

jobs:
  download:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          wget \
          unzip \
          gnupg \
          software-properties-common \
          apt-transport-https \
          ca-certificates \
          curl
    
    - name: Install Chrome
      run: |
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/google-chrome.gpg
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list > /dev/null
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
    
    - name: Install rclone
      run: |
        curl https://rclone.org/install.sh | sudo bash
    
    - name: Configure rclone
      run: |
        mkdir -p ~/.config/rclone
        cat > ~/.config/rclone/rclone.conf << 'EOF'
        ${{ secrets.RCLONE_CONFIG }}
        EOF
        # 설정 파일 확인
        if [ ! -f ~/.config/rclone/rclone.conf ]; then
          echo "Error: rclone.conf file was not created"
          exit 1
        fi
        echo "rclone configuration file created successfully"
    
    - name: Verify rclone configuration
      run: |
        rclone listremotes || echo "Warning: Could not list remotes"
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run download script
      env:
        CI: "1"
        ONEDRIVE_REMOTE: "onedrive:office work/부동산 실거래 데이터"
      run: |
        mode="${{ github.event.inputs.mode }}"
        if [ "$mode" = "update" ] || [ -z "$mode" ]; then
          python download_realdata.py --update-mode
        else
          python download_realdata.py
        fi
      continue-on-error: true
    
    - name: Upload progress file to OneDrive
      if: always()
      run: |
        if [ -f download_progress.json ]; then
          rclone copy download_progress.json "onedrive:office work/부동산 실거래 데이터/" --no-check-dest || echo "Failed to upload progress file"
        else
          echo "download_progress.json not found"
        fi
    
    - name: Upload logs as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: download-results
        path: |
          download_progress.json
          _downloads/
        if-no-files-found: ignore
        retention-days: 7
