name: Download Real Estate Data

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 2ì‹œ (KST ê¸°ì¤€) ì‹¤í–‰
    - cron: '0 17 * * *'  # UTC 17:00 = KST 02:00
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      mode:
        description: 'Download mode'
        required: false
        default: 'update'
        type: choice
        options:
          - update
          - full

jobs:
  download:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          wget \
          unzip \
          gnupg \
          software-properties-common \
          apt-transport-https \
          ca-certificates \
          curl
    
    - name: Install Chrome
      run: |
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/google-chrome.gpg
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list > /dev/null
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
    
    - name: Install rclone
      run: |
        curl https://rclone.org/install.sh | sudo bash
    
    - name: Configure rclone
      run: |
        mkdir -p ~/.config/rclone
        
        # RCLONE_CONFIG ì‹œí¬ë¦¿ í™•ì¸
        if [ -z "$RCLONE_CONFIG" ]; then
          echo "âŒ Error: RCLONE_CONFIG secret is empty or not set"
          exit 1
        fi
        
        echo "ğŸ”§ [DEBUG] RCLONE_CONFIG ê¸¸ì´: ${#RCLONE_CONFIG} ë¬¸ì"
        echo "ğŸ”§ [DEBUG] RCLONE_CONFIG ì²« 100ì: ${RCLONE_CONFIG:0:100}"
        
        # ì„¤ì • íŒŒì¼ ì‘ì„±
        echo "$RCLONE_CONFIG" > ~/.config/rclone/rclone.conf
        
        # ì„¤ì • íŒŒì¼ í™•ì¸
        if [ ! -f ~/.config/rclone/rclone.conf ]; then
          echo "âŒ Error: rclone.conf file was not created"
          exit 1
        fi
        
        if [ ! -s ~/.config/rclone/rclone.conf ]; then
          echo "âŒ Error: rclone.conf file is empty"
          exit 1
        fi
        
        echo "âœ… rclone.conf íŒŒì¼ ìƒì„± ì™„ë£Œ"
        echo "ğŸ”§ [DEBUG] íŒŒì¼ í¬ê¸°: $(wc -c < ~/.config/rclone/rclone.conf) bytes"
        echo "ğŸ”§ [DEBUG] íŒŒì¼ ì²« 200ì:"
        head -c 200 ~/.config/rclone/rclone.conf
        
      env:
        RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}
    
    - name: Verify rclone configuration
      run: |
        echo "ğŸ”§ [DEBUG] rclone ì„¤ì • íŒŒì¼ ìœ„ì¹˜: ~/.config/rclone/rclone.conf"
        echo "ğŸ”§ [DEBUG] ì„¤ì • íŒŒì¼ ì¡´ì¬ ì—¬ë¶€:"
        ls -la ~/.config/rclone/rclone.conf || echo "âŒ íŒŒì¼ ì—†ìŒ"
        
        echo ""
        echo "ğŸ”§ [DEBUG] rclone listremotes ì‹¤í–‰:"
        rclone listremotes || echo "âŒ listremotes ì‹¤íŒ¨"
        
        echo ""
        echo "ğŸ”§ [DEBUG] rclone config show onedrive ì‹¤í–‰:"
        rclone config show onedrive || echo "âŒ config show ì‹¤íŒ¨"
        
        echo ""
        echo "ğŸ”§ [DEBUG] onedrive ì›ê²© í…ŒìŠ¤íŠ¸:"
        rclone lsd onedrive: || echo "âŒ lsd ì‹¤íŒ¨"
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run download script
      env:
        CI: "1"
        ONEDRIVE_REMOTE: "onedrive:office work/ë¶€ë™ì‚° ì‹¤ê±°ë˜ ë°ì´í„°"
      run: |
        mode="${{ github.event.inputs.mode }}"
        if [ "$mode" = "update" ] || [ -z "$mode" ]; then
          python download_realdata.py --update-mode
        else
          python download_realdata.py
        fi
      continue-on-error: true
    
    - name: Upload progress file to OneDrive
      if: always()
      run: |
        if [ -f download_progress.json ]; then
          rclone copy download_progress.json "onedrive:office work/ë¶€ë™ì‚° ì‹¤ê±°ë˜ ë°ì´í„°/" --no-check-dest || echo "Failed to upload progress file"
        else
          echo "download_progress.json not found"
        fi
    
    - name: Upload logs as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: download-results
        path: |
          download_progress.json
          _downloads/
        if-no-files-found: ignore
        retention-days: 7
