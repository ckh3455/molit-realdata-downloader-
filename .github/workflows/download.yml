name: Download Real Estate Data

on:
  schedule:
    # 매일 오전 10시 (KST)
    - cron: '0 1 * * *'
  workflow_dispatch:  # 수동 실행 가능

jobs:
  download:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install Chrome
        uses: browser-actions/setup-chrome@latest
      
      - name: Install ChromeDriver
        uses: nanasess/setup-chromedriver@master
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Create output directory
        run: mkdir -p output
      
      - name: Download progress files from Google Drive
        env:
          SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          echo "$SERVICE_ACCOUNT" > service-account.json
          
          # 이전 진행 상황 다운로드
          python - <<'EOF'
          import os
          from pathlib import Path
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaIoBaseDownload
          import io
          
          SCOPES = ['https://www.googleapis.com/auth/drive.file']
          creds = service_account.Credentials.from_service_account_file(
              'service-account.json', scopes=SCOPES)
          service = build('drive', 'v3', credentials=creds)
          
          folder_id = os.environ['GDRIVE_FOLDER_ID']
          
          # 다운로드할 파일들
          files_to_download = ['download_progress.json', 'existing_files.json']
          
          for filename in files_to_download:
              # 파일 찾기
              query = f"name='{filename}' and '{folder_id}' in parents and trashed=false"
              results = service.files().list(q=query, fields='files(id, name)').execute()
              items = results.get('files', [])
              
              if items:
                  file_id = items[0]['id']
                  request = service.files().get_media(fileId=file_id)
                  
                  fh = io.BytesIO()
                  downloader = MediaIoBaseDownload(fh, request)
                  
                  done = False
                  while not done:
                      status, done = downloader.next_chunk()
                  
                  # 파일 저장
                  with open(filename, 'wb') as f:
                      f.write(fh.getvalue())
                  
                  print(f"✅ {filename} 다운로드")
              else:
                  print(f"⚠️  {filename} 없음 (처음 실행)")
          EOF
      
      - name: Check existing files in Google Drive
        env:
          SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
          SERVICE_ACCOUNT_JSON: service-account.json
        run: |
          echo "$SERVICE_ACCOUNT" > service-account.json
          python upload_to_gdrive.py --check-existing
      
      - name: Run download script
        env:
          CI: "1"
          CHROMEDRIVER_BIN: /usr/local/bin/chromedriver
          CHROME_BIN: /usr/bin/google-chrome
        run: |
          python download_realdata.py
      
      - name: Upload to Google Drive
        env:
          SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
          SERVICE_ACCOUNT_JSON: service-account.json
          OUTPUT_DIR: output
        run: |
          echo "$SERVICE_ACCOUNT" > service-account.json
          python upload_to_gdrive.py --upload
          
          # 진행 상황 파일도 Drive에 업로드
          python - <<'EOF'
          import os
          from pathlib import Path
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload
          
          SCOPES = ['https://www.googleapis.com/auth/drive.file']
          creds = service_account.Credentials.from_service_account_file(
              'service-account.json', scopes=SCOPES)
          service = build('drive', 'v3', credentials=creds)
          
          folder_id = os.environ['GDRIVE_FOLDER_ID']
          
          # 업로드할 파일들
          files_to_upload = ['download_progress.json', 'existing_files.json']
          
          for filename in files_to_upload:
              file_path = Path(filename)
              if not file_path.exists():
                  continue
              
              # 기존 파일 찾기
              query = f"name='{filename}' and '{folder_id}' in parents and trashed=false"
              results = service.files().list(q=query, fields='files(id, name)').execute()
              items = results.get('files', [])
              
              media = MediaFileUpload(str(file_path), resumable=True)
              
              if items:
                  # 업데이트
                  file_id = items[0]['id']
                  service.files().update(fileId=file_id, media_body=media).execute()
                  print(f"✅ {filename} 업데이트")
              else:
                  # 새로 생성
                  file_metadata = {'name': filename, 'parents': [folder_id]}
                  service.files().create(body=file_metadata, media_body=media).execute()
                  print(f"✅ {filename} 업로드")
          EOF
      
      - name: Upload logs as artifact (for debugging)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: download-logs
          path: |
            download_progress.json
            existing_files.json
            *.log
