name: Download Real Estate Data

on:
  schedule:
    # 매일 오전 10시 (KST)
    - cron: '0 1 * * *'
  workflow_dispatch:  # 수동 실행 가능

jobs:
  download:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install Chrome
        uses: browser-actions/setup-chrome@latest
      
      - name: Install ChromeDriver
        uses: nanasess/setup-chromedriver@master
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Create output directory
        run: mkdir -p output
      
      - name: Check existing files in Google Drive
        env:
          SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
          SERVICE_ACCOUNT_JSON: service-account.json
        run: |
          echo "$SERVICE_ACCOUNT" > service-account.json
          python upload_to_gdrive.py --check-existing
      
      - name: Run download script
        env:
          CI: "1"
          CHROMEDRIVER_BIN: /usr/local/bin/chromedriver
          CHROME_BIN: /usr/bin/google-chrome
        run: |
          python download_realdata.py
      
      - name: Upload to Google Drive
        env:
          SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
          SERVICE_ACCOUNT_JSON: service-account.json
          OUTPUT_DIR: output
        run: |
          echo "$SERVICE_ACCOUNT" > service-account.json
          python upload_to_gdrive.py --upload
      
      - name: Upload logs as artifact
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: download-logs
          path: |
            download_progress.json
            existing_files.json
            *.log
