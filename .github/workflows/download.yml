name: Download Real Estate Data

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 10ì‹œ (KST)
    - cron: '0 1 * * *'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  download:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install Chrome
        uses: browser-actions/setup-chrome@latest
      
      - name: Install ChromeDriver
        uses: nanasess/setup-chromedriver@master
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client
      
      - name: Create output directory
        run: mkdir -p output
      
      - name: Run download script
        env:
          CI: "1"
          CHROMEDRIVER_BIN: /usr/local/bin/chromedriver
          CHROME_BIN: /usr/bin/google-chrome
        run: |
          python download_realdata.py --update-mode
      
      - name: Upload to Google Drive
        env:
          SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          echo "$SERVICE_ACCOUNT" > service-account.json
          
          python - <<'EOF'
          import os
          import json
          from pathlib import Path
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload
          
          SCOPES = ['https://www.googleapis.com/auth/drive.file']
          
          # ì¸ì¦
          creds = service_account.Credentials.from_service_account_file(
              'service-account.json', scopes=SCOPES)
          service = build('drive', 'v3', credentials=creds)
          
          # output í´ë”ì˜ ëª¨ë“  íŒŒì¼ ì—…ë¡œë“œ
          output_dir = Path('output')
          folder_id = os.environ['FOLDER_ID']
          
          uploaded_count = 0
          
          for folder_path in output_dir.iterdir():
              if not folder_path.is_dir():
                  continue
              
              folder_name = folder_path.name
              
              # Driveì—ì„œ í•´ë‹¹ í´ë” ì°¾ê¸° ë˜ëŠ” ìƒì„±
              query = f"name='{folder_name}' and '{folder_id}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false"
              results = service.files().list(q=query, spaces='drive', fields='files(id, name)').execute()
              items = results.get('files', [])
              
              if items:
                  drive_folder_id = items[0]['id']
                  print(f"ðŸ“ í´ë” ì°¾ìŒ: {folder_name}")
              else:
                  # í´ë” ìƒì„±
                  folder_metadata = {
                      'name': folder_name,
                      'mimeType': 'application/vnd.google-apps.folder',
                      'parents': [folder_id]
                  }
                  folder_file = service.files().create(body=folder_metadata, fields='id').execute()
                  drive_folder_id = folder_file.get('id')
                  print(f"ðŸ“ í´ë” ìƒì„±: {folder_name}")
              
              # í´ë” ì•ˆì˜ íŒŒì¼ë“¤ ì—…ë¡œë“œ
              for file_path in folder_path.glob('*.xlsx'):
                  file_name = file_path.name
                  
                  # ê°™ì€ ì´ë¦„ íŒŒì¼ ì°¾ê¸°
                  query = f"name='{file_name}' and '{drive_folder_id}' in parents and trashed=false"
                  results = service.files().list(q=query, spaces='drive', fields='files(id, name)').execute()
                  items = results.get('files', [])
                  
                  if items:
                      # ê¸°ì¡´ íŒŒì¼ ì—…ë°ì´íŠ¸
                      file_id = items[0]['id']
                      media = MediaFileUpload(str(file_path), resumable=True)
                      service.files().update(fileId=file_id, media_body=media).execute()
                      print(f"  âœ… ì—…ë°ì´íŠ¸: {file_name}")
                  else:
                      # ìƒˆ íŒŒì¼ ì—…ë¡œë“œ
                      file_metadata = {
                          'name': file_name,
                          'parents': [drive_folder_id]
                      }
                      media = MediaFileUpload(str(file_path), resumable=True)
                      service.files().create(body=file_metadata, media_body=media, fields='id').execute()
                      print(f"  âœ… ì—…ë¡œë“œ: {file_name}")
                  
                  uploaded_count += 1
          
          print(f"\nðŸŽ‰ ì´ {uploaded_count}ê°œ íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ!")
          EOF
      
      - name: Upload logs as artifact
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: download-logs
          path: |
            download_progress.json
            *.log
