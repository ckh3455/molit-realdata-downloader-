name: Real Estate Full Download (Self-hosted)

1. ìŠ¤ì¼€ì¤„ ì‹¤í–‰ (ë§¤ì¼ ìƒˆë²½ 2ì‹œ 15ë¶„) - ë‹¤ìš´ë¡œë“œ ì œí•œ 100ê±´ ëŒ€ì‘

on:
schedule:
# í•œêµ­ ì‹œê°„ ê¸°ì¤€ ìƒˆë²½ 2ì‹œ 15ë¶„ (UTC 17ì‹œ 15ë¶„)
# ì´ ì‹œê°„ì— ìŠ¤í¬ë¦½íŠ¸ê°€ ì‹¤í–‰ë˜ì–´ ì–´ì œ 100ê±´ ì œí•œì— ê±¸ë ¸ë‹¤ë©´ ì´ì–´ì„œ ë‹¤ìš´ë¡œë“œë¥¼ ì¬ê°œí•©ë‹ˆë‹¤.
- cron: '15 17 * * *'

2. ìˆ˜ë™ ì‹¤í–‰ì„ ìœ„í•œ ì„¤ì • (ëª¨ë“œ ì„ íƒ ê°€ëŠ¥)

workflow_dispatch:
inputs:
mode:
description: 'ì‹¤í–‰ ëª¨ë“œ ì„ íƒ: full (ì „ì²´ ë‹¤ìš´ë¡œë“œ), update (ìµœê·¼ 1ë…„ ê°±ì‹ )'
required: true
default: 'full'
type: choice
options:
- full
- update

permissions:
contents: read

jobs:
full-download:
# ğŸš¨ ì‹¤í–‰ í™˜ê²½: Self-hosted Runnerë¥¼ ì‚¬ìš©í•˜ë„ë¡ ì§€ì •í•©ë‹ˆë‹¤.
runs-on: self-hosted
timeout-minutes: 90 # ì¶©ë¶„í•œ ì‹¤í–‰ ì‹œê°„ ë¶€ì—¬

env:
  CI: "1"
  PYTHONUNBUFFERED: "1"
  
steps:
  - name: Checkout Repository
    uses: actions/checkout@v4
    
  # 1. PowerShell ì‹¤í–‰ ì •ì±… ìš°íšŒ (PowerShell ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì˜¤ë¥˜ í•´ê²°)
  - name: Set Execution Policy Bypass for Scripts
    shell: powershell
    run: Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass

  # 2. Python í™˜ê²½ ì„¤ì •
  - name: Set up Python
    uses: actions/setup-python@v5
    with:
      python-version: "3.11"
      
  # 3. Python ì˜ì¡´ì„± ì„¤ì¹˜
  - name: Install dependencies
    run: |
      pip install -r requirements.txt
      
  # 4. ë‹¤ìš´ë¡œë“œ ì‹¤í–‰ (ëª¨ë“œì— ë”°ë¼ ëª…ë ¹ ë³€ê²½)
  - name: Run Data Downloader
    id: downloader
    shell: powershell
    run: |
      $mode = "${{ github.event.inputs.mode }}"
      $command = "python download_realdata.py 2>&1 | Out-File download_log.txt -Encoding utf8"

      if ($mode -eq 'update') {
          $command = "python download_realdata.py --update-mode 2>&1 | Out-File download_log.txt -Encoding utf8"
          echo "mode=Update" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          echo "Starting update mode: last 1 year data."
      } else {
          echo "mode=Full/Resume" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          echo "Starting full download or resuming previous run (2006-01 to present)."
      }

      # ìµœì¢… ëª…ë ¹ ì‹¤í–‰
      Write-Host "Executing command: $command"
      Invoke-Expression $command
    
    # ë‹¤ìš´ë¡œë“œ ì¤‘ 100íšŒ ì œí•œì— ê±¸ë¦¬ë©´ ìŠ¤í¬ë¦½íŠ¸ê°€ ì¢…ë£Œë˜ë¯€ë¡œ, ì—ëŸ¬ë¥¼ ë¬´ì‹œí•©ë‹ˆë‹¤.
    continue-on-error: true

  # 5. ê²°ê³¼ ë¡œê·¸ ì¶œë ¥ ë° ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
  - name: Show Results and Upload Artifacts
    if: always()
    shell: powershell
    run: |
      echo "========== Execution Log =========="
      Get-Content download_log.txt -ErrorAction SilentlyContinue
      echo ""
      echo "========== Downloaded Files in Output Folder =========="
      # ì´ ê²½ë¡œëŠ” CI í™˜ê²½ (output) ê¸°ì¤€ì…ë‹ˆë‹¤. ë¡œì»¬ ì €ì¥ì†Œ (D:\OneDrive...)ëŠ” ì—¬ê¸°ì— í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
      Get-ChildItem -Path output -Recurse -Filter "*.xlsx" | Select-Object FullName | Format-List
      echo ""
      echo "========== Progress Status =========="
      Get-Content download_progress.json -ErrorAction SilentlyContinue
      
    # ë‹¤ìš´ë¡œë“œëœ íŒŒì¼ì€ ë¡œì»¬ OneDrive ê²½ë¡œì— ì €ì¥ë˜ì§€ë§Œ,
    # Artifactë¡œ ì—…ë¡œë“œí•˜ì—¬ GitHubì—ì„œë„ ìµœì¢… ë¡œê·¸ì™€ ì§„í–‰ ìƒí™©ì„ ë³¼ ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.
  - name: Upload Logs and Progress
    if: always()
    uses: actions/upload-artifact@v4
    with:
      name: full-download-results
      path: |
        download_log.txt
        download_progress.json
      if-no-files-found: ignore
      retention-days: 7
